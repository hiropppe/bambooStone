from bamboo.go import timer
from bamboo.models import policy
from bamboo.ai.greedy import GreedyPolicyPlayer
from bamboo.gtp.gtp_connector import GTPGameConnector
from bamboo.gtp.gtp_wrapper import ExtendedGtpEngine

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(description='Run GTP')
    parser.add_argument("model",
                        help="Policy network model json.")
    parser.add_argument("weights",
                        help="Policy network weights hdf5.")
    parser.add_argument("--n-playout", type=int, default=10,
                        help="Number of simulation for each play")
    parser.add_argument("--time", "-t", type=str, default='2000 50 180 6',
                        help="Time settings supporting Canadian byo-yomi. \
                              Main time, Byo-yomi time and Byo-yomi stone")
    parser.add_argument("--server", default=False, action="store_true",
                        help="Server mode")
    parser.add_argument("--player", "-p", type=str, default='mcts', choices=['mcts', 'prob', 'greedy'],
                        help="Choice player type (Default: mcts)")
    parser.add_argument("--policy-temp", type=float, default=0.67,
                        help="Distribution temperature of players using policies (Default: 0.67)")
    parser.add_argument("--greedy-start", type=int, default=None,
                        help="Greedy start option for ProbabilisticPolicyPlayer (Default: None)")

    args = parser.parse_args()

    import tensorflow as tf
    from keras.backend.tensorflow_backend import set_session
    config = tf.ConfigProto()
    config.gpu_options.per_process_gpu_memory_fraction = 0.2
    set_session(tf.Session(config=config))

    # value net is not implemented yet
    # value_net = None

    sl_policy = policy.CNNPolicy.load_model(args.model)
    sl_policy.model.load_weights(args.weights)

    # fast rollout is not implemented yet
    # fast_sl_policy = sl_policy

    # m, ms, b, bs = [(int)(t) for t in args.time.split()]

    player = GreedyPolicyPlayer(sl_policy)

    gtp_game = GTPGameConnector(player)
    gtp_engine = ExtendedGtpEngine(gtp_game, name='bambooStone', version='0.0')

    if args.server:
        from flask import Flask
        from flask import request

        app = Flask(__name__)

        @app.route('/gtp')
        def gtp():
            cmd = request.args.get('cmd')
            print(cmd)
            engine_reply = gtp_engine.send(cmd)
            print(engine_reply)
            return engine_reply

        app.run(host="0.0.0.0", port=5001, debug=False, threaded=True)
    else:
        from bamboo.gtp.gtp_wrapper import run_gtp
        run_gtp(player)
